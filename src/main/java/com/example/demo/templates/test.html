<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>VLM Education Assistant</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* æŒ‰é’®æ ·å¼ */
        .style-btn {
            padding: 8px 16px;
            margin-right: 8px;
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .style-btn:hover { background-color: #e0e0e0; }
        .style-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }
        /* æ•™è‚²æŠ¥å‘Šä¸“å±æŒ‰é’®æ ·å¼ */
        .style-btn.edu-btn {
            background-color: #e3f2fd;
            color: #1565c0;
            border-color: #90caf9;
        }
        .style-btn.edu-btn.active {
            background-color: #2196f3;
            color: white;
            border-color: #1976d2;
        }

        /* å¸ƒå±€æ ·å¼ */
        .input-group { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; }

        /* ç”»æ¿æ ·å¼ */
        canvas { background-color: white; cursor: crosshair; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ç»“æœå±•ç¤ºæ ·å¼ */
        #result { background: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-wrap; margin-top: 20px; border: 1px solid #eee; }

        /* æŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .report-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .report-section { margin-bottom: 15px; }
        .report-label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        .tag { display: inline-block; background: #e1f5fe; color: #0277bd; padding: 3px 8px; border-radius: 12px; font-size: 0.9em; margin-right: 5px; }
        .interpretation-box { background: #f9fbe7; padding: 15px; border-left: 5px solid #c0ca33; border-radius: 4px; color: #33691e; }
    </style>
</head>
<body>

<h2>ğŸ¨ AI ç»˜ç”»åˆ†æä¸æ•™è‚²è¯„ä¼° (VLM Demo)</h2>

<div class="input-group">
    <div style="margin-bottom: 10px;">
        <strong>1. é€‰æ‹©è¾“å…¥æ–¹å¼ï¼š</strong>
        <label><input type="radio" name="inputMode" value="upload" checked onclick="toggleInput('upload')"> ä¸Šä¼ å›¾ç‰‡</label>
        <label><input type="radio" name="inputMode" value="draw" onclick="toggleInput('draw')"> åœ¨çº¿ç»˜ç”» (Canvas)</label>
    </div>

    <div id="uploadArea">
        <input type="file" id="imageInput" accept="image/*">
    </div>

    <div id="drawArea" style="display:none;">
        <canvas id="myCanvas" width="500" height="350" style="border:1px solid #ccc;"></canvas>
        <div style="margin-top:5px;">
            <button onclick="clearCanvas()" style="font-size: 0.8em;">ğŸ§¹ æ¸…ç©ºç”»æ¿</button>
            <span style="color:#666; font-size: 0.8em; margin-left: 10px;">* è¯·åœ¨ç™½è‰²åŒºåŸŸå†…è‡ªç”±ç»˜ç”»</span>
        </div>
    </div>
</div>

<div class="input-group">
    <strong>2. æç¤ºè¯è®¾ç½®ï¼š</strong><br><br>
    <label>ç”¨æˆ·é—®é¢˜ (User Prompt):</label>
    <input type="text" id="promptInput" value="è¿™å¼ ç”»é‡Œé¢æœ‰ä»€ä¹ˆï¼Ÿè¡¨ç°äº†ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"><br><br>

    <label>ç³»ç»Ÿæç¤ºè¯ (System Prompt - ä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ç”Ÿæ•ˆ):</label>
    <textarea id="systemPromptInput" rows="2">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒåˆ†æåŠ©æ‰‹ã€‚</textarea>
</div>

<div class="input-group">
    <strong>3. é€‰æ‹©åˆ†ææ¨¡å¼ï¼š</strong><br><br>
    <button class="style-btn active" onclick="setStyle('normal',this)">æ™®é€šåˆ†æ</button>
    <button class="style-btn" onclick="setStyle('detail',this)">è¯¦ç»†åˆ†æ</button>
    <button class="style-btn" onclick="setStyle('kids',this)">å„¿ç«¥è®²è§£</button>
    <button class="style-btn edu-btn" onclick="setStyle('education_report',this)">ğŸ“ æ•™è‚²è¯„ä¼°æŠ¥å‘Š</button>
</div>

<button onclick="send()" style="padding: 10px 25px; background: #333; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px;">
    ğŸš€ å¼€å§‹åˆ†æ (SEND)
</button>

<div id="loading" style="display:none; margin-top: 20px; color: #666;">
    â³ æ­£åœ¨é€šè¿‡ AI åˆ†æç”»ä½œï¼Œè¯·ç¨å€™...
</div>

<div id="result"></div>

<script>
    // --- å…¨å±€çŠ¶æ€ ---
    let currentStyle = 'normal';

    // --- ç”»æ¿é€»è¾‘ ---
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // åˆå§‹åŒ–ç”»å¸ƒèƒŒæ™¯ä¸ºç™½è‰²ï¼ˆé˜²æ­¢é€æ˜èƒŒæ™¯ä¼ ç»™ AI å˜é»‘ï¼‰
    function initCanvas() {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    initCanvas();

    canvas.addEventListener('mousedown', (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = 'black';
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
    });
    canvas.addEventListener('mouseup', () => { isDrawing = false; });

    function clearCanvas() { initCanvas(); }

    function toggleInput(mode) {
        document.getElementById('uploadArea').style.display = mode === 'upload' ? 'block' : 'none';
        document.getElementById('drawArea').style.display = mode === 'draw' ? 'block' : 'none';
    }

    // --- æ ·å¼åˆ‡æ¢ ---
    function setStyle(style, btn) {
        currentStyle = style;
        document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // --- æ ¸å¿ƒå‘é€é€»è¾‘ ---
    function send() {
        const prompt = document.getElementById("promptInput").value;
        const systemPrompt = document.getElementById("systemPromptInput").value;
        const mode = document.querySelector('input[name="inputMode"]:checked').value;

        const formData = new FormData();
        formData.append("prompt", prompt);
        formData.append("systemPrompt", systemPrompt);
        formData.append("style", currentStyle);

        // å¤„ç†å›¾ç‰‡æ¥æº
        if (mode === 'upload') {
            const imageFile = document.getElementById("imageInput").files[0];
            if (!imageFile) { alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼"); return; }
            formData.append("image", imageFile);
            submitData(formData);
        } else {
            // å°† Canvas è½¬ä¸º Blob
            canvas.toBlob((blob) => {
                formData.append("image", blob, "drawing.png");
                submitData(formData);
            }, 'image/png');
        }
    }

    function submitData(formData) {
        document.getElementById("loading").style.display = "block";
        document.getElementById("result").innerHTML = "";

        fetch("http://localhost:8080/analyze", {
            method: "POST",
            body: formData
        })
            .then(res => res.text())
            .then(text => {
                document.getElementById("loading").style.display = "none";

                // å¦‚æœæ˜¯æ•™è‚²æŠ¥å‘Šæ¨¡å¼ï¼Œå°è¯•è§£æ JSON å¹¶æ¸²æŸ“å¡ç‰‡
                if (currentStyle === 'education_report') {
                    try {
                        const data = JSON.parse(text);
                        renderReport(data);
                    } catch (e) {
                        console.error("JSON Parse Error", e);
                        document.getElementById("result").textContent = "è§£ææŠ¥å‘Šå¤±è´¥ï¼ŒåŸå§‹è¿”å›:\n" + text;
                    }
                } else {
                    // æ™®é€šæ¨¡å¼ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                    document.getElementById("result").textContent = text;
                }
            })
            .catch(err => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("result").textContent = "Error: " + err;
            });
    }

    // --- æ¸²æŸ“æ•™è‚²è¯„ä¼°æŠ¥å‘Š (PDF Requirement Step 2 & 3) ---
    function renderReport(data) {
        // æ„å»ºæ ‡ç­¾ HTML
        const tagsHtml = data.interest_tags
            ? data.interest_tags.map(tag => `<span class="tag">${tag}</span>`).join('')
            : 'æ— ';

        const html = `
            <div class="report-card">
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ç»˜ç”»å¿ƒç†ä¸å…´è¶£è¯„ä¼°æŠ¥å‘Š</h3>

                <div class="report-section">
                    <span class="report-label">ğŸ‘ï¸ ç”»é¢å†…å®¹ (Content Description):</span>
                    <div>${data.content_description || 'æš‚æ— æè¿°'}</div>
                </div>

                <div class="report-section">
                    <span class="report-label">ğŸ­ é£æ ¼ç‰¹å¾ (Stylistic Features):</span>
                    <div>${data.stylistic_features || 'æš‚æ— ç‰¹å¾'}</div>
                </div>

                <div class="report-section">
                    <span class="report-label">ğŸ·ï¸ å…´è¶£æ ‡ç­¾ (Interest Tags):</span>
                    <div style="margin-top:5px;">${tagsHtml}</div>
                </div>

                <div class="interpretation-box">
                    <span class="report-label" style="color:#33691e;">ğŸ’¡ æ½œèƒ½ä¸å…´è¶£è§£è¯» (Generative Interpretation):</span>
                    <div style="margin-top:5px;">${data.interest_interpretation || 'æ— æ³•ç”Ÿæˆè§£è¯»'}</div>
                </div>
            </div>
        `;
        document.getElementById("result").innerHTML = html;
    }
</script>

</body>
</html>